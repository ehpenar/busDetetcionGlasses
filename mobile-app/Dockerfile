#  Dockerfile para Bus Detection Mobile App
# Este archivo define c贸mo construir la imagen de Docker

# Usar Node.js 18 Alpine (ligero y seguro)
FROM node:18-alpine

#  Explicaci贸n: Alpine Linux es una distribuci贸n muy ligera (5MB vs 200MB+ de Ubuntu)
# Node.js 18 es la versi贸n LTS (Long Term Support) m谩s estable

# Establecer directorio de trabajo dentro del contenedor
WORKDIR /app

#  Explicaci贸n: WORKDIR crea y navega al directorio /app dentro del contenedor
# Todo lo que copiemos y ejecutemos estar谩 en este directorio

# Instalar dependencias del sistema necesarias para Expo
RUN apk add --no-cache \
    git \
    curl \
    bash \
    python3 \
    make \
    g++

#  Explicaci贸n: apk es el gestor de paquetes de Alpine Linux
# Instalamos herramientas necesarias para compilar dependencias nativas

# Copiar archivos de configuraci贸n de Node.js
COPY package*.json ./

#  Explicaci贸n: Copiamos package.json y package-lock.json primero
# Esto permite que Docker cache las dependencias si no cambian

# Instalar dependencias de Node.js
RUN npm install --omit=dev --legacy-peer-deps

#  Explicaci贸n: npm install instala las dependencias
# --omit=dev instala solo dependencias de producci贸n (no devDependencies)

# Instalar Expo CLI globalmente dentro del contenedor
RUN npm install -g @expo/cli

#  Explicaci贸n: Expo CLI se instala globalmente dentro del contenedor
# No afecta tu sistema host, solo el contenedor

# Copiar el c贸digo fuente de la aplicaci贸n
COPY . .

#  Explicaci贸n: Copiamos todos los archivos del proyecto al contenedor
# El .dockerignore excluir谩 archivos innecesarios

# Exponer el puerto que usa Expo
EXPOSE 19000 19001 19002

#  Explicaci贸n: Expo usa m煤ltiples puertos:
# 19000: Metro bundler (servidor de desarrollo)
# 19001: Expo DevTools
# 19002: Expo DevTools (alternativo)

# Crear usuario no-root para seguridad
RUN addgroup -g 1001 -S nodejs && \
    adduser -S expo -u 1001 -G nodejs

#  Explicaci贸n: Por seguridad, no ejecutamos como root
# Creamos un usuario espec铆fico para la aplicaci贸n

# Cambiar al usuario no-root
USER expo

#  Explicaci贸n: Cambiamos al usuario expo antes de ejecutar la app
# Esto previene vulnerabilidades de seguridad

# Comando por defecto
CMD ["npx", "expo", "start", "--lan"]

#  Explicaci贸n: --lan permite conexiones desde la red local
# Esto hace que la app sea accesible desde el celular en la misma red WiFi
